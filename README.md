# 基本要素 #
一套最精简的后台部署中，至少需要以下如下核心元素及各要素承担的职责。

## mainService server ##
与管理前端及展示前端适配的后台服务，基本以Restful API方式构架，基于Flask实现。

在生产环境中需同时配套gunicorn及nginx优化并发性能，满足未来的可能大并发场景。

由于mainService需频繁访问缓存，因此为了节约系统资源、尽量提升接口效率，redis server也在本最小构架中安装在 mainService server上。


最小构架中本服务器还承担了静态资源服务器的角色，在网站PV较低时可以胜任，在对网站性能响应要求较高时需单独设立静态资源服务器或购买相关云产品比如oss及cdn。

## mysql server ##
mysql数据库用于存储用户及角色权限信息、项目及数据终端信息、实时数据及云点值，mysql不承担历史数据存储和项目日志。

mysql数据库结合redis提升系统响应性能。

mysql建议主从式设计，实现读写分离。写入mysql的负荷主要集中在现场数据接收后的实时表更新、同时计算数据会被触发运算同时更新数据表。读取负荷主要来自网站访问和计算运算取值。h

## messqge queue server ##

消息队列的主要作用是作为中间件优化系统运行性能，触发式的数据流能提高系统响应速度并节省空闲资源。

消息队列主要处理以下类型的消息：
1. 邮件及短信消息发送处理
2. 计算点触发一次计算
3. 计算点触发一次强制优先计算
4. 报警触发一次检测
5. 数据诊断和策略触发一次运行
6. 外部数据接入的mqtt接口数据处理

## dataService server ##
承担所有与数据查询和请求处理等消耗内存性能及io的后台请求。

最小构架中，本服务器还承担着计算诊断接口服务（dataExpert service）的服务器职责，在高可用构架中建议将该职责独立服务器。

最小构架中，本服务器还承担着系统任务（systemTask）的服务器职责，在高可用构架中建议将该职责独立服务器。

systemTask主要做哪些事情？
---
目前已支持的基本功能是：
每天凌晨备份指定的配置信息，除系统设置备份外的额外保护
处理系统中所有发邮件短信的事务
检查数据完整性并对缺失计算点数据进行自动补全

---

## dataDriver server##
数据驱动服务器是所有外部项目/物联数据的入口接收服务器，这台服务器承担了维护各类项目数据在线和接收的关口重任，对网络带宽要求高，同时需要运行解包服务端程序，需具备容错能力和防止ddos攻击的能力。


## dataExpert job server##
本服务器负责计算点运算、数据报警触发、诊断和策略的触发运算，与消息队列结合多进程工作

消费消息后将触发一次计算，对cpu要求较高

另外提供接口服务功能，可用于对计算脚本和诊断运算脚本进行在线测试。



## mongo server ##

mongo存储的数据分为两种类型：
1.项目历史数据，计算及诊断中间数据，log

2.与具体项目无关的配置信息

这两类数据分立为两个mongo实例来存储，方便管理和隔离。


# 综上得到的一张最小构架图 #

